//@version=5
strategy("MACD Strategy", shorttitle="MACD", overlay=true, default_qty_type=strategy.percent_of_equity, default_qty_value=100)

//@strategy_description=This script implements a MACD strategy for long positions in stocks. It uses MACD, signal line, and SMA to determine entry and exit points for long positions.
//@tags=macd, ema, sma, strategy, trading, stocks

// Input parameters
var float fastLength = input.float(50, "Fast Length", minval=1, maxval=200, step=1)
var float slowLength = input.float(75, "Slow Length", minval=1, maxval=200, step=1)
var float macdLength = input.float(35, "MACD Length", minval=1, maxval=100, step=1)
var int smaLength = input.int(250, "SMA Length", minval=1, maxval=500, step=1)

// Calculate MACD components
float fastEMA = ta.ema(close, fastLength)
float slowEMA = ta.ema(close, slowLength)
float macdLine = fastEMA - slowEMA
float signalLine = ta.ema(macdLine, macdLength)
float histogram = macdLine - signalLine

// Calculate SMA
float sma = ta.sma(close, smaLength)

// Entry and exit conditions
bool longCondition = histogram > 0 and close > sma
bool exitCondition = close < sma

// Strategy execution
if (longCondition)
    strategy.entry("Long", strategy.long)

if (exitCondition)
    strategy.close("Long")

// Plotting
plot(histogram, title="MACD Histogram", style=plot.style_histogram, color=color.new(color.black, 0))
plot(macdLine, title="MACD Line", color=color.new(color.blue, 0))
plot(signalLine, title="Signal Line", color=color.new(color.orange, 0))
plot(sma, title="SMA", color=color.new(color.red, 0))

// Performance metrics
var float initialEquity = strategy.equity
var float maxDrawdown = 0.0
var float maxDrawdownPct = 0.0

float currentDrawdown = (strategy.equity - strategy.equity_peak) / strategy.equity_peak * 100
maxDrawdown := math.max(maxDrawdown, strategy.equity_peak - strategy.equity)
maxDrawdownPct := math.max(maxDrawdownPct, currentDrawdown)

var table perfTable = table.new(position.top_right, 2, 4, border_width=1)
if (barstate.islastconfirmedhistory)
    table.cell(perfTable, 0, 0, "Total Return", bgcolor=color.new(color.blue, 90))
    table.cell(perfTable, 1, 0, str.tostring((strategy.equity - initialEquity) / initialEquity * 100, "#.##") + "%", bgcolor=color.new(color.blue, 90))
    table.cell(perfTable, 0, 1, "Max Drawdown", bgcolor=color.new(color.red, 90))
    table.cell(perfTable, 1, 1, str.tostring(maxDrawdownPct, "#.##") + "%", bgcolor=color.new(color.red, 90))
    table.cell(perfTable, 0, 2, "Profit Factor", bgcolor=color.new(color.green, 90))
    table.cell(perfTable, 1, 2, str.tostring(strategy.grossprofit / strategy.grossloss, "#.##"), bgcolor=color.new(color.green, 90))
    table.cell(perfTable, 0, 3, "Total Trades", bgcolor=color.new(color.yellow, 90))
    table.cell(perfTable, 1, 3, str.tostring(strategy.closedtrades), bgcolor=color.new(color.yellow, 90))
